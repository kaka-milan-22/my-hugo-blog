<!DOCTYPE html>
<html lang="zh"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">2026 年了，直接用 PostgreSQL 吧 | 我的技术博客</title>
<meta property="og:title" content="2026 年了，直接用 PostgreSQL 吧 | 我的技术博客" />
<meta name="twitter:title" content="2026 年了，直接用 PostgreSQL 吧 | 我的技术博客" />
<meta itemprop="name" content="2026 年了，直接用 PostgreSQL 吧 | 我的技术博客" />
<meta name="application-name" content="2026 年了，直接用 PostgreSQL 吧 | 我的技术博客" />
<meta property="og:site_name" content="" />

<meta name="description" content="深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债">
<meta itemprop="description" content="深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债" />
<meta property="og:description" content="深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债" />
<meta name="twitter:description" content="深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债" />

<meta property="og:locale" content="zh" />
<meta name="language" content="zh" />

  <link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/2026-02-15-postgres-2026/" title="中文" />





    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2026-02-15T10:00:00&#43;0800 />
    <meta property="article:published_time" content=2026-02-15T10:00:00&#43;0800 />
    <meta property="og:url" content="http://localhost:1313/posts/2026-02-15-postgres-2026/" />

    
    <meta property="og:article:author" content="Kaka" />
    <meta property="article:author" content="Kaka" />
    <meta name="author" content="Kaka" />
    
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "2026 年了，直接用 PostgreSQL 吧",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2026-02-15",
        "description": "深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债",
        "wordCount":  6302 ,
        "mainEntityOfPage": "True",
        "dateModified": "2026-02-15",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "我的技术博客"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.154.3">

    
    <meta property="og:url" content="http://localhost:1313/posts/2026-02-15-postgres-2026/">
  <meta property="og:site_name" content="我的技术博客">
  <meta property="og:title" content="2026 年了，直接用 PostgreSQL 吧">
  <meta property="og:description" content="深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-02-15T10:00:00+08:00">
    <meta property="article:modified_time" content="2026-02-15T10:00:00+08:00">
    <meta property="article:tag" content="PostgreSQL">
    <meta property="article:tag" content="Database">
    <meta property="article:tag" content="Architecture">
    <meta property="article:tag" content="Devops">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="2026 年了，直接用 PostgreSQL 吧">
  <meta name="twitter:description" content="深入解析为什么在 2026 年应该选择 PostgreSQL 作为首选数据库，而不是维护一堆专用数据库的技术债">


    

    <link rel="canonical" href="http://localhost:1313/posts/2026-02-15-postgres-2026/">
    <link href="/style.min.e390ba7da26222f4dc42a349955d76dbbe44e5ce2535a43de5a70633a0a9ec3c.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">
    <meta name="color-scheme" content="light dark">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title></title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        首页
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        文章
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/tags/">
                        标签
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        关于
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">2026 年了，直接用 PostgreSQL 吧</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2026-02-15T10:00:00&#43;08:00" itemprop="datePublished"> 2026年2月15日 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b></b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#引言">引言</a></li>
    <li><a href="#使用正确工具的陷阱">「使用正确工具」的陷阱</a></li>
    <li><a href="#为什么现在这很重要ai-时代">为什么现在这很重要：AI 时代</a></li>
    <li><a href="#但专用数据库更好">「但专用数据库更好！」</a>
      <ul>
        <li><a href="#postgresql-vs-专用数据库算法对比">PostgreSQL vs 专用数据库算法对比</a></li>
      </ul>
    </li>
    <li><a href="#隐藏成本不断累积">隐藏成本不断累积</a></li>
    <li><a href="#现代-postgresql-技术栈">现代 PostgreSQL 技术栈</a>
      <ul>
        <li><a href="#ai-时代的扩展">AI 时代的扩展</a></li>
      </ul>
    </li>
    <li><a href="#快速开始添加这些扩展">快速开始：添加这些扩展</a></li>
    <li><a href="#实战代码示例">实战代码示例</a>
      <ul>
        <li><a href="#全文搜索替代-elasticsearch">全文搜索（替代 Elasticsearch）</a></li>
        <li><a href="#混合搜索在一个查询中结合-bm25--向量">混合搜索：在一个查询中结合 BM25 + 向量</a></li>
        <li><a href="#向量搜索替代-pinecone">向量搜索（替代 Pinecone）</a></li>
        <li><a href="#时序数据替代-influxdb">时序数据（替代 InfluxDB）</a></li>
        <li><a href="#缓存替代-redis">缓存（替代 Redis）</a></li>
        <li><a href="#消息队列替代-kafka">消息队列（替代 Kafka）</a></li>
        <li><a href="#文档存储替代-mongodb">文档存储（替代 MongoDB）</a></li>
        <li><a href="#地理空间替代专用-gis">地理空间（替代专用 GIS）</a></li>
        <li><a href="#定时任务替代-cron">定时任务（替代 Cron）</a></li>
        <li><a href="#混合搜索bm25--向量">混合搜索（BM25 + 向量）</a></li>
        <li><a href="#模糊搜索拼写容错">模糊搜索（拼写容错）</a></li>
        <li><a href="#图遍历替代图数据库">图遍历（替代图数据库）</a></li>
      </ul>
    </li>
    <li><a href="#底线">底线</a></li>
    <li><a href="#运维最佳实践">运维最佳实践</a>
      <ul>
        <li><a href="#性能优化">性能优化</a></li>
        <li><a href="#监控关键指标">监控关键指标</a></li>
        <li><a href="#备份与恢复">备份与恢复</a></li>
        <li><a href="#高可用架构">高可用架构</a></li>
        <li><a href="#安全加固">安全加固</a></li>
      </ul>
    </li>
    <li><a href="#权衡与选择">权衡与选择</a>
      <ul>
        <li><a href="#优势">优势</a></li>
        <li><a href="#劣势">劣势</a></li>
        <li><a href="#何时选择-postgresql">何时选择 PostgreSQL</a></li>
        <li><a href="#那-1-的情况">那 1% 的情况</a></li>
      </ul>
    </li>
    <li><a href="#迁移策略">迁移策略</a>
      <ul>
        <li><a href="#从-elasticsearch-迁移">从 Elasticsearch 迁移</a></li>
        <li><a href="#从-mongodb-迁移">从 MongoDB 迁移</a></li>
        <li><a href="#从-redis-迁移">从 Redis 迁移</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a>
      <ul>
        <li><a href="#行动建议">行动建议</a></li>
      </ul>
    </li>
    <li><a href="#参考资源">参考资源</a>
      <ul>
        <li><a href="#官方文档">官方文档</a></li>
        <li><a href="#扩展资源">扩展资源</a></li>
        <li><a href="#学习资源">学习资源</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <h2 id="引言">引言</h2>
<p>想象一下你的数据库就像你的家。你的家有客厅、卧室、浴室、厨房和车库，每个房间都有不同的用途。但它们都在同一个屋檐下，通过走廊和门连接在一起。你不会仅仅因为需要做饭就建一个独立的餐厅大楼，也不会在城市另一端建一个商业车库只为停车。</p>
<p><strong>这就是 PostgreSQL 的理念</strong>：一个有多个房间的家。搜索、向量、时序、队列——都在同一个屋檐下。</p>
<p>但这正是专业数据库厂商不希望你听到的。他们的市场团队花了数年时间说服你「为正确的工作使用正确的工具」。这听起来很合理，很明智。而且能卖出很多数据库。</p>
<p>让我告诉你为什么这是个陷阱，以及为什么在 99% 的情况下 PostgreSQL 才是更好的选择。</p>
<h2 id="使用正确工具的陷阱">「使用正确工具」的陷阱</h2>
<p>你听过这个建议：<em>「为正确的工作使用正确的工具」</em></p>
<p>听起来很明智。于是你最终得到了：</p>
<ol>
<li><strong>Elasticsearch</strong> - 用于搜索</li>
<li><strong>Pinecone</strong> - 用于向量搜索</li>
<li><strong>Redis</strong> - 用于缓存</li>
<li><strong>MongoDB</strong> - 用于文档存储</li>
<li><strong>Kafka</strong> - 用于消息队列</li>
<li><strong>InfluxDB</strong> - 用于时序数据</li>
<li><strong>PostgreSQL</strong> - 用于…剩下的东西</li>
</ol>
<p>恭喜你。你现在有七个数据库要管理：</p>
<ul>
<li>七种查询语言要学习</li>
<li>七种备份策略要维护</li>
<li>七个安全模型要审计</li>
<li>六套凭证要轮换</li>
<li>七个监控面板要看</li>
<li>七个可能在凌晨 3 点崩溃的东西</li>
</ul>
<p>当某个东西真的崩溃时？祝你好运能快速启动一个测试环境来调试。</p>
<p>这里有个不同的想法：<strong>直接用 PostgreSQL</strong>。</p>
<h2 id="为什么现在这很重要ai-时代">为什么现在这很重要：AI 时代</h2>
<p>这不仅仅是为了简单性。<strong>AI Agent 让数据库蔓延变成了一场噩梦</strong>。</p>
<p>想想 Agent 需要做什么：</p>
<ul>
<li>快速用生产数据启动测试数据库</li>
<li>尝试修复或实验</li>
<li>验证是否有效</li>
<li>然后销毁</li>
</ul>
<p><strong>用一个数据库？</strong> 一条命令就够了。Fork、测试、完成。</p>
<p><strong>用七个数据库？</strong> 现在你需要：</p>
<ul>
<li>协调 Postgres、Elasticsearch、Pinecone、Redis、MongoDB 和 Kafka 的快照</li>
<li>确保它们都在同一个时间点</li>
<li>启动七个不同的服务</li>
<li>配置七个不同的连接字符串</li>
<li>祈祷在测试时没有数据漂移</li>
<li>完成后拆除七个服务</li>
</ul>
<p>如果没有大量的研发投入，这几乎是不可能的。</p>
<p>而且不仅仅是 Agent。每次凌晨 3 点出问题时，你都需要启动一个测试环境来调试。六个数据库意味着协调噩梦。一个数据库，只需一条命令。</p>
<p>在 AI 时代，<strong>简单性不仅仅是优雅。它是必需品</strong>。</p>
<h2 id="但专用数据库更好">「但专用数据库更好！」</h2>
<p>让我们正面解决这个问题。</p>
<p><strong>神话</strong>：专用数据库在特定任务上远远优于通用数据库。</p>
<p><strong>现实</strong>：有时它们在狭窄的任务上略好一些。但它们也带来了不必要的复杂性。就像为每顿饭雇一个私人厨师。听起来很奢侈，但增加了费用、协调开销，并制造了你之前没有的问题。</p>
<p>事实是：<strong>99% 的公司不需要它们</strong>。排名前 1% 的公司拥有数千万用户和相匹配的庞大工程团队。你读过他们关于专用数据库 X 如何为他们工作的博客文章。但那是他们的规模、他们的团队、他们的问题。对其他人来说，PostgreSQL 绰绰有余。</p>
<p>大多数人没有意识到的是：<strong>PostgreSQL 扩展使用与专用数据库相同或更好的算法（在许多情况下）</strong>。</p>
<p>「专用数据库」的溢价？主要是营销。</p>
<h3 id="postgresql-vs-专用数据库算法对比">PostgreSQL vs 专用数据库算法对比</h3>
<table>
  <thead>
      <tr>
          <th>需求</th>
          <th>专用工具</th>
          <th>PostgreSQL 扩展</th>
          <th>算法相同？</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>全文搜索</td>
          <td>Elasticsearch</td>
          <td>pg_textsearch</td>
          <td>✅ 都使用 BM25</td>
      </tr>
      <tr>
          <td>向量搜索</td>
          <td>Pinecone</td>
          <td>pgvector + pgvectorscale</td>
          <td>✅ 都使用 HNSW/DiskANN</td>
      </tr>
      <tr>
          <td>时序数据</td>
          <td>InfluxDB</td>
          <td>TimescaleDB</td>
          <td>✅ 都使用时间分区</td>
      </tr>
      <tr>
          <td>缓存</td>
          <td>Redis</td>
          <td>UNLOGGED tables</td>
          <td>✅ 都使用内存存储</td>
      </tr>
      <tr>
          <td>文档存储</td>
          <td>MongoDB</td>
          <td>JSONB</td>
          <td>✅ 都使用文档索引</td>
      </tr>
      <tr>
          <td>地理空间</td>
          <td>专用 GIS</td>
          <td>PostGIS</td>
          <td>✅ 自 2001 年以来的行业标准</td>
      </tr>
  </tbody>
</table>
<p>这些不是打折版本。它们是<strong>相同/更好的算法</strong>，经过实战测试、开源，并且通常由相同的研究人员开发。</p>
<p>基准测试支持这一点：</p>
<ul>
<li><strong>pgvectorscale</strong>：在 99% 召回率下，延迟比 Pinecone 低 28 倍，成本降低 75%</li>
<li><strong>TimescaleDB</strong>：匹配或超越 InfluxDB，同时提供完整的 SQL</li>
<li><strong>pg_textsearch</strong>：与 Elasticsearch 相同的 BM25 排名算法</li>
</ul>
<h2 id="隐藏成本不断累积">隐藏成本不断累积</h2>
<p>除了 AI/Agent 问题，数据库蔓延还有复合成本：</p>
<table>
  <thead>
      <tr>
          <th>任务</th>
          <th>一个数据库</th>
          <th>七个数据库</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>备份策略</td>
          <td>1</td>
          <td>7</td>
      </tr>
      <tr>
          <td>监控面板</td>
          <td>1</td>
          <td>7</td>
      </tr>
      <tr>
          <td>安全补丁</td>
          <td>1</td>
          <td>7</td>
      </tr>
      <tr>
          <td>值班手册</td>
          <td>1</td>
          <td>7</td>
      </tr>
      <tr>
          <td>故障转移测试</td>
          <td>1</td>
          <td>7</td>
      </tr>
  </tbody>
</table>
<p><strong>认知负担</strong>：你的团队需要学习 SQL、Redis 命令、Elasticsearch Query DSL、MongoDB 聚合、Kafka 模式和 InfluxDB 的非原生 SQL 变通方法。这不是专业化，这是<strong>碎片化</strong>。</p>
<p><strong>数据一致性</strong>：让 Elasticsearch 与 Postgres 保持同步？你构建同步任务。它们失败了。数据漂移。你添加协调机制。那也失败了。现在你在维护基础设施而不是构建功能。</p>
<p><strong>SLA 数学</strong>：三个系统各有 99.9% 的正常运行时间 = 99.7% 的组合正常运行时间。这意味着每年<strong>停机 26 小时</strong>而不是 8.7 小时。每个系统都会增加你的故障模式。</p>
<h2 id="现代-postgresql-技术栈">现代 PostgreSQL 技术栈</h2>
<p>这些扩展并不新鲜。它们已经在生产环境中使用多年：</p>
<ul>
<li><strong>PostGIS</strong>：自 2001 年以来（24 年）。为 OpenStreetMap 和 Uber 提供支持</li>
<li><strong>全文搜索</strong>：自 2008 年以来（17 年）。内置于 Postgres 核心</li>
<li><strong>JSONB</strong>：自 2014 年以来（11 年）。与 MongoDB 一样快，具有 ACID</li>
<li><strong>TimescaleDB</strong>：自 2017 年以来（8 年）。21K+ GitHub stars</li>
<li><strong>pgvector</strong>：自 2021 年以来（4 年）。19K+ GitHub stars</li>
</ul>
<p>超过 48,000 家公司使用 PostgreSQL，包括 Netflix、Spotify、Uber、Reddit、Instagram 和 Discord。</p>
<h3 id="ai-时代的扩展">AI 时代的扩展</h3>
<p>AI 时代带来了新一代扩展：</p>
<table>
  <thead>
      <tr>
          <th>扩展</th>
          <th>替代品</th>
          <th>亮点</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>pgvectorscale</td>
          <td>Pinecone, Qdrant</td>
          <td>DiskANN 算法。延迟降低 28 倍，成本降低 75%</td>
      </tr>
      <tr>
          <td>pg_textsearch</td>
          <td>Elasticsearch</td>
          <td>原生 BM25 排名</td>
      </tr>
      <tr>
          <td>pgai</td>
          <td>外部 AI 管道</td>
          <td>数据变化时自动同步嵌入</td>
      </tr>
  </tbody>
</table>
<p><strong>这意味着什么</strong>：构建 RAG 应用过去需要 Postgres + Pinecone + Elasticsearch + 粘合代码。</p>
<p>现在？<strong>只需 PostgreSQL</strong>。一个数据库，一种查询语言，一次备份，一个 fork 命令让你的 AI Agent 启动测试环境。</p>
<h2 id="快速开始添加这些扩展">快速开始：添加这些扩展</h2>
<p>你只需要这些：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 使用 BM25 的全文搜索
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pg_textsearch;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- AI 向量搜索
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION vector;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION vectorscale;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- AI 嵌入和 RAG 工作流
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION ai;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 时序数据
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION timescaledb;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 消息队列
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pgmq;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 定时任务
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pg_cron;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 地理空间
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION postgis;
</span></span></code></pre></td></tr></table>
</div>
</div><p>就是这样。</p>
<h2 id="实战代码示例">实战代码示例</h2>
<p>以下是每个用例的实际示例。跳到你需要的部分。</p>
<h3 id="全文搜索替代-elasticsearch">全文搜索（替代 Elasticsearch）</h3>
<p><strong>扩展</strong>：pg_textsearch（真正的 BM25 排名）</p>
<p>你正在替代的：</p>
<ul>
<li><strong>Elasticsearch</strong>：独立的 JVM 集群、复杂映射、同步管道、Java 堆调优</li>
<li><strong>Solr</strong>：同样的问题，不同的包装</li>
<li><strong>Algolia</strong>：每 1000 次搜索 $1，外部 API 依赖</li>
</ul>
<p>你得到的：为 Elasticsearch 提供支持的<strong>完全相同的 BM25 算法</strong>，直接在 Postgres 中。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 创建表
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> articles (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  title TEXT,
</span></span><span style="display:flex;"><span>  content TEXT
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建 BM25 索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_articles_bm25 <span style="color:#66d9ef">ON</span> articles 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">USING</span> bm25(content) <span style="color:#66d9ef">WITH</span> (text_config <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;english&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 使用 BM25 评分搜索
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> title, <span style="color:#f92672">-</span>(content <span style="color:#f92672">&lt;@&gt;</span> <span style="color:#e6db74">&#39;database optimization&#39;</span>) <span style="color:#66d9ef">as</span> score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> articles
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> content <span style="color:#f92672">&lt;@&gt;</span> <span style="color:#e6db74">&#39;database optimization&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="混合搜索在一个查询中结合-bm25--向量">混合搜索：在一个查询中结合 BM25 + 向量</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  title,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span>(content <span style="color:#f92672">&lt;@&gt;</span> <span style="color:#e6db74">&#39;database optimization&#39;</span>) <span style="color:#66d9ef">as</span> bm25_score,
</span></span><span style="display:flex;"><span>  embedding <span style="color:#f92672">&lt;=&gt;</span> query_embedding <span style="color:#66d9ef">as</span> vector_distance,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>(content <span style="color:#f92672">&lt;@&gt;</span> <span style="color:#e6db74">&#39;database optimization&#39;</span>)) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> (embedding <span style="color:#f92672">&lt;=&gt;</span> query_embedding)) <span style="color:#66d9ef">as</span> hybrid_score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> articles
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> hybrid_score <span style="color:#66d9ef">DESC</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是 Elasticsearch 需要单独插件才能完成的功能。在 Postgres 中，这只是 SQL。</p>
<h3 id="向量搜索替代-pinecone">向量搜索（替代 Pinecone）</h3>
<p><strong>扩展</strong>：pgvector + pgvectorscale</p>
<p>你正在替代的：</p>
<ul>
<li><strong>Pinecone</strong>：每月最低 $70、独立基础设施、数据同步难题</li>
<li><strong>Qdrant、Milvus、Weaviate</strong>：更多需要管理的基础设施</li>
</ul>
<p>你得到的：pgvectorscale 使用 <strong>DiskANN 算法</strong>（来自微软研究院），在 99% 召回率下实现了比 Pinecone <strong>低 28 倍的 p95 延迟</strong>和 <strong>16 倍的吞吐量</strong>。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 启用扩展
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION vector;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION vectorscale <span style="color:#66d9ef">CASCADE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 带嵌入的表
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> documents (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  content TEXT,
</span></span><span style="display:flex;"><span>  embedding vector(<span style="color:#ae81ff">1536</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 高性能索引（DiskANN）
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_docs_embedding <span style="color:#66d9ef">ON</span> documents 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">USING</span> diskann(embedding);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 查找相似文档
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> content, embedding <span style="color:#f92672">&lt;=&gt;</span> <span style="color:#e6db74">&#39;[0.1, 0.2, ...]&#39;</span>::vector <span style="color:#66d9ef">as</span> distance
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> documents
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> embedding <span style="color:#f92672">&lt;=&gt;</span> <span style="color:#e6db74">&#39;[0.1, 0.2, ...]&#39;</span>::vector
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>使用 pgai 自动同步嵌入</strong>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> ai.create_vectorizer(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;documents&#39;</span>::regclass,
</span></span><span style="display:flex;"><span>  loading <span style="color:#f92672">=&gt;</span> ai.loading_column(<span style="color:#66d9ef">column_name</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;content&#39;</span>),
</span></span><span style="display:flex;"><span>  embedding <span style="color:#f92672">=&gt;</span> ai.embedding_openai(
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;text-embedding-3-small&#39;</span>, 
</span></span><span style="display:flex;"><span>    dimensions<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;1536&#39;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在每次 INSERT/UPDATE 都会自动重新生成嵌入。没有同步任务，没有漂移，没有凌晨 3 点的故障。</p>
<h3 id="时序数据替代-influxdb">时序数据（替代 InfluxDB）</h3>
<p><strong>扩展</strong>：TimescaleDB（21K+ GitHub stars）</p>
<p>你正在替代的：</p>
<ul>
<li><strong>InfluxDB</strong>：独立数据库、Flux 查询语言或非原生 SQL、有限的 SQL 支持</li>
<li><strong>Prometheus</strong>：适合指标，但不适合应用数据</li>
</ul>
<p>你得到的：自动时间分区、高达 90% 的压缩、连续聚合。完整的 SQL。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 启用 TimescaleDB
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION timescaledb;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建表
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> metrics (
</span></span><span style="display:flex;"><span>  time TIMESTAMPTZ <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  device_id TEXT,
</span></span><span style="display:flex;"><span>  temperature DOUBLE <span style="color:#66d9ef">PRECISION</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 转换为超表
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> create_hypertable(<span style="color:#e6db74">&#39;metrics&#39;</span>, <span style="color:#e6db74">&#39;time&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 使用时间桶查询
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  time_bucket(<span style="color:#e6db74">&#39;1 hour&#39;</span>, time) <span style="color:#66d9ef">as</span> hour,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AVG</span>(temperature)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> metrics
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> time <span style="color:#f92672">&gt;</span> NOW() <span style="color:#f92672">-</span> INTERVAL <span style="color:#e6db74">&#39;24 hours&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> hour;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 自动删除旧数据
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> add_retention_policy(<span style="color:#e6db74">&#39;metrics&#39;</span>, INTERVAL <span style="color:#e6db74">&#39;30 days&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 压缩（减少 90% 存储）
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> metrics <span style="color:#66d9ef">SET</span> (timescaledb.compress);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> add_compression_policy(<span style="color:#e6db74">&#39;metrics&#39;</span>, INTERVAL <span style="color:#e6db74">&#39;7 days&#39;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="缓存替代-redis">缓存（替代 Redis）</h3>
<p><strong>功能</strong>：UNLOGGED 表 + JSONB</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- UNLOGGED = 无 WAL 开销，更快的写入
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> UNLOGGED <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">cache</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">key</span> TEXT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  value JSONB,
</span></span><span style="display:flex;"><span>  expires_at TIMESTAMPTZ
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 设置过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> <span style="color:#66d9ef">cache</span> (<span style="color:#66d9ef">key</span>, value, expires_at)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;user:123&#39;</span>, <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;Alice&#34;}&#39;</span>, NOW() <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 hour&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ON</span> CONFLICT (<span style="color:#66d9ef">key</span>) <span style="color:#66d9ef">DO</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">SET</span> value <span style="color:#f92672">=</span> EXCLUDED.value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 获取
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> value <span style="color:#66d9ef">FROM</span> <span style="color:#66d9ef">cache</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;user:123&#39;</span> <span style="color:#66d9ef">AND</span> expires_at <span style="color:#f92672">&gt;</span> NOW();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 清理（使用 pg_cron 调度）
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> <span style="color:#66d9ef">cache</span> <span style="color:#66d9ef">WHERE</span> expires_at <span style="color:#f92672">&lt;</span> NOW();
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="消息队列替代-kafka">消息队列（替代 Kafka）</h3>
<p><strong>扩展</strong>：pgmq</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pgmq;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> pgmq.<span style="color:#66d9ef">create</span>(<span style="color:#e6db74">&#39;my_queue&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 发送
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> pgmq.send(<span style="color:#e6db74">&#39;my_queue&#39;</span>, <span style="color:#e6db74">&#39;{&#34;event&#34;: &#34;signup&#34;, &#34;user_id&#34;: 123}&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 接收（带可见性超时）
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> pgmq.<span style="color:#66d9ef">read</span>(<span style="color:#e6db74">&#39;my_queue&#39;</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 处理后删除
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> pgmq.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;my_queue&#39;</span>, msg_id);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>或使用原生 SKIP LOCKED 模式</strong>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> jobs (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  payload JSONB,
</span></span><span style="display:flex;"><span>  status TEXT <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;pending&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Worker 原子性地声明任务
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> jobs <span style="color:#66d9ef">SET</span> status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;processing&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> id <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SELECT</span> id <span style="color:#66d9ef">FROM</span> jobs <span style="color:#66d9ef">WHERE</span> status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;pending&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FOR</span> <span style="color:#66d9ef">UPDATE</span> SKIP LOCKED <span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>) RETURNING <span style="color:#f92672">*</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="文档存储替代-mongodb">文档存储（替代 MongoDB）</h3>
<p><strong>功能</strong>：原生 JSONB</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> users (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">data</span> JSONB
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 插入嵌套文档
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> users (<span style="color:#66d9ef">data</span>) <span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;name&#34;: &#34;Alice&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;profile&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;bio&#34;: &#34;Developer&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;links&#34;: [&#34;github.com/alice&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 查询嵌套字段
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;name&#39;</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;profile&#39;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;bio&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> users
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;profile&#39;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;bio&#39;</span> <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;%Developer%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 索引 JSON 字段
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_users_email <span style="color:#66d9ef">ON</span> users ((<span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;email&#39;</span>));
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="地理空间替代专用-gis">地理空间（替代专用 GIS）</h3>
<p><strong>扩展</strong>：PostGIS</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION postgis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> stores (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  name TEXT,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">location</span> GEOGRAPHY(POINT, <span style="color:#ae81ff">4326</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 查找 5 公里内的商店
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  name, 
</span></span><span style="display:flex;"><span>  ST_Distance(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">location</span>, 
</span></span><span style="display:flex;"><span>    ST_MakePoint(<span style="color:#f92672">-</span><span style="color:#ae81ff">122</span>.<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">37</span>.<span style="color:#ae81ff">78</span>)::geography
</span></span><span style="display:flex;"><span>  ) <span style="color:#66d9ef">as</span> meters
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> stores
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> ST_DWithin(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">location</span>, 
</span></span><span style="display:flex;"><span>  ST_MakePoint(<span style="color:#f92672">-</span><span style="color:#ae81ff">122</span>.<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">37</span>.<span style="color:#ae81ff">78</span>)::geography, 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="定时任务替代-cron">定时任务（替代 Cron）</h3>
<p><strong>扩展</strong>：pg_cron</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pg_cron;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 每小时运行
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> cron.schedule(<span style="color:#e6db74">&#39;cleanup&#39;</span>, <span style="color:#e6db74">&#39;0 * * * *&#39;</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">$$</span><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> <span style="color:#66d9ef">cache</span> <span style="color:#66d9ef">WHERE</span> expires_at <span style="color:#f92672">&lt;</span> NOW()<span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 每晚汇总
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> cron.schedule(<span style="color:#e6db74">&#39;rollup&#39;</span>, <span style="color:#e6db74">&#39;0 2 * * *&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">$$</span>REFRESH MATERIALIZED <span style="color:#66d9ef">VIEW</span> CONCURRENTLY daily_stats$$
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="混合搜索bm25--向量">混合搜索（BM25 + 向量）</h3>
<p>对于 AI 应用，你通常需要<strong>关键词搜索和语义搜索</strong>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 倒数排名融合：结合关键词 + 语义搜索
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">WITH</span> bm25 <span style="color:#66d9ef">AS</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SELECT</span> id, ROW_NUMBER() OVER (<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> content <span style="color:#f92672">&lt;@&gt;</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">as</span> rank
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FROM</span> documents <span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>vectors <span style="color:#66d9ef">AS</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SELECT</span> id, ROW_NUMBER() OVER (<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> embedding <span style="color:#f92672">&lt;=&gt;</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> rank  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FROM</span> documents <span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  d.<span style="color:#f92672">*</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">60</span> <span style="color:#f92672">+</span> COALESCE(b.rank, <span style="color:#ae81ff">1000</span>)) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">60</span> <span style="color:#f92672">+</span> COALESCE(v.rank, <span style="color:#ae81ff">1000</span>)) <span style="color:#66d9ef">as</span> score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> documents d
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> bm25 b <span style="color:#66d9ef">ON</span> d.id <span style="color:#f92672">=</span> b.id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> vectors v <span style="color:#66d9ef">ON</span> d.id <span style="color:#f92672">=</span> v.id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> b.id <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">OR</span> v.id <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> score <span style="color:#66d9ef">DESC</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>试试用 Elasticsearch + Pinecone 做这个。你需要两次 API 调用、结果合并、故障处理和双倍延迟。</p>
<p>在 Postgres 中：一个查询，一个事务，一个结果。</p>
<h3 id="模糊搜索拼写容错">模糊搜索（拼写容错）</h3>
<p><strong>扩展</strong>：pg_trgm（内置于 Postgres）</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pg_trgm;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_name_trgm <span style="color:#66d9ef">ON</span> products 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">USING</span> GIN (name gin_trgm_ops);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 即使有拼写错误也能找到 &#34;PostgreSQL&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name <span style="color:#66d9ef">FROM</span> products
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> name <span style="color:#f92672">%</span> <span style="color:#e6db74">&#39;posgresql&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> similarity(name, <span style="color:#e6db74">&#39;posgresql&#39;</span>) <span style="color:#66d9ef">DESC</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="图遍历替代图数据库">图遍历（替代图数据库）</h3>
<p><strong>功能</strong>：递归 CTE</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 查找经理下的所有下属（组织架构）
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">RECURSIVE</span> org_tree <span style="color:#66d9ef">AS</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SELECT</span> id, name, manager_id, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">as</span> depth
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FROM</span> employees <span style="color:#66d9ef">WHERE</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SELECT</span> e.id, e.name, e.manager_id, t.depth <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FROM</span> employees e
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">JOIN</span> org_tree t <span style="color:#66d9ef">ON</span> e.manager_id <span style="color:#f92672">=</span> t.id
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">WHERE</span> t.depth <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> org_tree;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="底线">底线</h2>
<p>记住家的类比？你不会为了做晚饭就建一个独立的餐厅。你不会在城市另一端建商业车库只为停车。你使用家里的房间。</p>
<p>这就是我们在这里展示给你的。搜索、向量、时序、文档、队列、缓存——它们都是 Postgres 家中的房间。与专用数据库相同的算法。经过多年的实战测试。被 Netflix、Uber、Discord 和其他 48,000 家公司使用。</p>
<p><strong>那 99% 呢？</strong></p>
<p>对于 99% 的公司，Postgres 处理你需要的一切。那 1% 呢？那是当你在数百个节点上处理 PB 级日志时，或者需要 Kibana 的特定仪表板，或者有真正超出 Postgres 能力的异常需求时。</p>
<p>但事实是：<strong>当你进入那 1% 时，你会知道的</strong>。你不需要供应商的营销团队告诉你。你会自己进行基准测试并遇到真正的瓶颈。</p>
<p>在那之前，不要因为有人告诉你「为正确的工作使用正确的工具」而将数据分散到七个建筑中。这个建议卖数据库，但不为你服务。</p>
<p>从 Postgres 开始。坚持使用 Postgres。只有在你真正需要时才增加复杂性。</p>
<p><strong>2026 年了，直接用 PostgreSQL 吧</strong>。</p>
<h2 id="运维最佳实践">运维最佳实践</h2>
<h3 id="性能优化">性能优化</h3>
<p><strong>连接池配置</strong>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 使用 pgBouncer 进行连接池
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> pgbouncer.ini
</span></span><span style="display:flex;"><span>[databases]
</span></span><span style="display:flex;"><span>mydb <span style="color:#f92672">=</span> <span style="color:#66d9ef">host</span><span style="color:#f92672">=</span>localhost port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span> dbname<span style="color:#f92672">=</span>mydb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[pgbouncer]
</span></span><span style="display:flex;"><span>pool_mode <span style="color:#f92672">=</span> <span style="color:#66d9ef">transaction</span>
</span></span><span style="display:flex;"><span>max_client_conn <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>default_pool_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>查询优化</strong>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 分析查询性能
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXPLAIN</span> (<span style="color:#66d9ef">ANALYZE</span>, BUFFERS) <span style="color:#66d9ef">SELECT</span> ...;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建适当的索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> CONCURRENTLY idx_users_email <span style="color:#66d9ef">ON</span> users(email);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 使用部分索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_active_users <span style="color:#66d9ef">ON</span> users(email) 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;active&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 表达式索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_lower_email <span style="color:#66d9ef">ON</span> users(<span style="color:#66d9ef">LOWER</span>(email));
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="监控关键指标">监控关键指标</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 慢查询监控
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  query,
</span></span><span style="display:flex;"><span>  calls,
</span></span><span style="display:flex;"><span>  total_exec_time,
</span></span><span style="display:flex;"><span>  mean_exec_time,
</span></span><span style="display:flex;"><span>  max_exec_time
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> pg_stat_statements
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> mean_exec_time <span style="color:#66d9ef">DESC</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 表膨胀检查
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  schemaname,
</span></span><span style="display:flex;"><span>  tablename,
</span></span><span style="display:flex;"><span>  pg_size_pretty(pg_total_relation_size(schemaname<span style="color:#f92672">||</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">||</span>tablename)) <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">size</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> pg_tables
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> pg_total_relation_size(schemaname<span style="color:#f92672">||</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">||</span>tablename) <span style="color:#66d9ef">DESC</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 连接数监控
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>  datname,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">as</span> connections,
</span></span><span style="display:flex;"><span>  max_conn <span style="color:#f92672">-</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">as</span> available
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> pg_stat_activity, 
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">SELECT</span> setting::int <span style="color:#66d9ef">as</span> max_conn <span style="color:#66d9ef">FROM</span> pg_settings <span style="color:#66d9ef">WHERE</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;max_connections&#39;</span>) mc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> datname, max_conn;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="备份与恢复">备份与恢复</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 逻辑备份</span>
</span></span><span style="display:flex;"><span>pg_dump -Fc mydb &gt; backup.dump
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 恢复</span>
</span></span><span style="display:flex;"><span>pg_restore -d mydb backup.dump
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 物理备份（使用 pg_basebackup）</span>
</span></span><span style="display:flex;"><span>pg_basebackup -D /backup/dir -Ft -z -P
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 时间点恢复（PITR）配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># postgresql.conf</span>
</span></span><span style="display:flex;"><span>wal_level <span style="color:#f92672">=</span> replica
</span></span><span style="display:flex;"><span>archive_mode <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>archive_command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp %p /archive/%f&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="高可用架构">高可用架构</h3>
<pre tabindex="0"><code>┌──────────────────────────────────────┐
│         Load Balancer / HAProxy      │
└────────┬─────────────────────────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│Primary│ │Standby│
│ (RW)  │ │  (RO) │
└───┬───┘ └───┬───┘
    │         │
    │ Streaming Replication
    └─────────┘
</code></pre><p><strong>配置流复制</strong>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- Primary 配置
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> postgresql.conf
</span></span><span style="display:flex;"><span>wal_level <span style="color:#f92672">=</span> replica
</span></span><span style="display:flex;"><span>max_wal_senders <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>wal_keep_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>GB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> pg_hba.conf
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">host</span> replication replicator standby_ip<span style="color:#f92672">/</span><span style="color:#ae81ff">32</span> md5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Standby 配置
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> standby.signal <span style="color:#960050;background-color:#1e0010">文件</span>
</span></span><span style="display:flex;"><span>standby_mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;on&#39;</span>
</span></span><span style="display:flex;"><span>primary_conninfo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;host=primary_ip port=5432 user=replicator&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安全加固">安全加固</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 创建只读用户
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">ROLE</span> readonly_user LOGIN PASSWORD <span style="color:#e6db74">&#39;strong_password&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">CONNECT</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DATABASE</span> mydb <span style="color:#66d9ef">TO</span> readonly_user;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">USAGE</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">SCHEMA</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">TO</span> readonly_user;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">ALL</span> TABLES <span style="color:#66d9ef">IN</span> <span style="color:#66d9ef">SCHEMA</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">TO</span> readonly_user;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 行级安全（RLS）
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> POLICY user_data_policy <span style="color:#66d9ef">ON</span> users
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">FOR</span> <span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">USING</span> (user_id <span style="color:#f92672">=</span> current_user_id());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> users ENABLE <span style="color:#66d9ef">ROW</span> <span style="color:#66d9ef">LEVEL</span> <span style="color:#66d9ef">SECURITY</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- SSL 连接
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> postgresql.conf
</span></span><span style="display:flex;"><span>ssl <span style="color:#f92672">=</span> <span style="color:#66d9ef">on</span>
</span></span><span style="display:flex;"><span>ssl_cert_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/path/to/server.crt&#39;</span>
</span></span><span style="display:flex;"><span>ssl_key_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/path/to/server.key&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="权衡与选择">权衡与选择</h2>
<h3 id="优势">优势</h3>
<p>✅ <strong>统一技术栈</strong>：一种查询语言、一套工具、一个备份策略
✅ <strong>降低运维复杂度</strong>：无需维护多个数据库系统
✅ <strong>成本效益</strong>：减少许可费用和基础设施成本
✅ <strong>数据一致性</strong>：无需跨数据库同步
✅ <strong>AI 友好</strong>：轻松 fork 整个环境用于测试
✅ <strong>成熟稳定</strong>：30+ 年历史，生产级可靠性</p>
<h3 id="劣势">劣势</h3>
<p>❌ <strong>学习曲线</strong>：需要深入了解扩展生态系统
❌ <strong>单点故障</strong>：所有鸡蛋在一个篮子里（通过 HA 缓解）
❌ <strong>可能不是「最佳」</strong>：在某些极端场景下可能略逊于专用工具</p>
<h3 id="何时选择-postgresql">何时选择 PostgreSQL</h3>
<p><strong>适合使用 Postgres</strong>：</p>
<ul>
<li>启动新项目或重构现有系统</li>
<li>团队规模 &lt; 50 人</li>
<li>需要多种数据存储能力</li>
<li>想要简化运维</li>
<li>构建 AI/ML 应用</li>
</ul>
<p><strong>考虑专用工具</strong>：</p>
<ul>
<li>PB 级日志分析（Elasticsearch + Kibana 的可视化）</li>
<li>需要 Kafka 的特定流处理生态</li>
<li>极端规模（数十亿用户级别）</li>
<li>已有大量投资且迁移成本高</li>
</ul>
<h3 id="那-1-的情况">那 1% 的情况</h3>
<p>你会知道自己是否在那 1% 中，因为：</p>
<ul>
<li>你已经对 Postgres 进行了基准测试并遇到真正的瓶颈</li>
<li>你有专门的 DBA 团队</li>
<li>你在处理 PB 级数据</li>
<li>你的工程团队 &gt; 100 人</li>
<li>你有预算支持多个数据库团队</li>
</ul>
<p><strong>不是因为</strong>：</p>
<ul>
<li>供应商的销售演示很吸引人</li>
<li>你在科技博客上读到它</li>
<li>你觉得「听起来更专业」</li>
</ul>
<h2 id="迁移策略">迁移策略</h2>
<h3 id="从-elasticsearch-迁移">从 Elasticsearch 迁移</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 1. 安装扩展
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION pg_textsearch;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 2. 创建等效模式
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> products (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  name TEXT,
</span></span><span style="display:flex;"><span>  description TEXT,
</span></span><span style="display:flex;"><span>  price NUMERIC
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 3. 创建搜索索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_products_search <span style="color:#66d9ef">ON</span> products 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">USING</span> bm25(description) <span style="color:#66d9ef">WITH</span> (text_config <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;english&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 4. 数据迁移
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- 使用 Elasticsearch 的 scroll API 导出数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- 然后批量导入到 Postgres
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 5. 更新应用代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- 之前: ES query DSL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- 现在: 简单的 SQL
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> products
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> description <span style="color:#f92672">@@</span> <span style="color:#e6db74">&#39;laptop&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#f92672">-</span>(description <span style="color:#f92672">&lt;@&gt;</span> <span style="color:#e6db74">&#39;laptop&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="从-mongodb-迁移">从 MongoDB 迁移</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 1. 创建带 JSONB 的表
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> orders (
</span></span><span style="display:flex;"><span>  id SERIAL <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">data</span> JSONB,
</span></span><span style="display:flex;"><span>  created_at TIMESTAMPTZ <span style="color:#66d9ef">DEFAULT</span> NOW()
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 2. 创建索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_orders_user <span style="color:#66d9ef">ON</span> orders ((<span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;user_id&#39;</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_orders_status <span style="color:#66d9ef">ON</span> orders ((<span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;status&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 3. 数据导出和导入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- mongoexport --db mydb --collection orders --out orders.json
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- 然后使用 Python/Go 脚本转换并导入
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 4. 查询模式转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- MongoDB: db.orders.find({&#34;user_id&#34;: &#34;123&#34;, &#34;status&#34;: &#34;pending&#34;})
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Postgres:
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;user_id&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;123&#39;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;status&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;pending&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="从-redis-迁移">从 Redis 迁移</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 1. 创建缓存表
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> UNLOGGED <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">cache</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">key</span> TEXT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  value JSONB,
</span></span><span style="display:flex;"><span>  expires_at TIMESTAMPTZ
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 2. 创建索引
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_cache_expires <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">cache</span>(expires_at) 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> expires_at <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 3. 设置自动清理
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> cron.schedule(<span style="color:#e6db74">&#39;cache_cleanup&#39;</span>, <span style="color:#e6db74">&#39;*/5 * * * *&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">$$</span><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> <span style="color:#66d9ef">cache</span> <span style="color:#66d9ef">WHERE</span> expires_at <span style="color:#f92672">&lt;</span> NOW()<span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 4. 应用代码转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Redis: redis.setex(&#39;user:123&#39;, 3600, json_data)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Postgres:
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> <span style="color:#66d9ef">cache</span> (<span style="color:#66d9ef">key</span>, value, expires_at)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;user:123&#39;</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>, NOW() <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 hour&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ON</span> CONFLICT (<span style="color:#66d9ef">key</span>) <span style="color:#66d9ef">DO</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">SET</span> 
</span></span><span style="display:flex;"><span>  value <span style="color:#f92672">=</span> EXCLUDED.value,
</span></span><span style="display:flex;"><span>  expires_at <span style="color:#f92672">=</span> EXCLUDED.expires_at;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p>想象一下，如果你的数据基础设施就像你的家：</p>
<ul>
<li><strong>一个屋檐</strong>：PostgreSQL</li>
<li><strong>多个房间</strong>：搜索、向量、时序、队列、缓存</li>
<li><strong>一套钥匙</strong>：SQL</li>
<li><strong>一个地址</strong>：连接字符串</li>
<li><strong>一次清洁</strong>：备份和维护</li>
</ul>
<p>这就是 PostgreSQL 在 2026 年提供的：<strong>简单性、强大性和实用性的完美平衡</strong>。</p>
<h3 id="行动建议">行动建议</h3>
<ol>
<li><strong>评估当前架构</strong>：列出你正在使用的所有数据库</li>
<li><strong>识别低挂果实</strong>：从最容易迁移的开始（通常是缓存和队列）</li>
<li><strong>小步快跑</strong>：一次迁移一个用例</li>
<li><strong>测量性能</strong>：确保满足你的需求</li>
<li><strong>简化运维</strong>：享受减少的复杂性</li>
</ol>
<p>记住：<strong>为正确的工作使用正确的工具</strong> 是个好建议。但当一个工具就能胜任 99% 的工作时，或许你应该重新考虑什么是「正确」。</p>
<p><strong>2026 年了，直接用 PostgreSQL 吧</strong>。</p>
<h2 id="参考资源">参考资源</h2>
<h3 id="官方文档">官方文档</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/">PostgreSQL 官方文档</a></li>
<li><a href="https://docs.timescale.com/">TimescaleDB 文档</a></li>
<li><a href="https://postgis.net/documentation/">PostGIS 文档</a></li>
<li><a href="https://github.com/pgvector/pgvector">pgvector 文档</a></li>
</ul>
<h3 id="扩展资源">扩展资源</h3>
<ul>
<li><a href="https://github.com/timescale/pg_textsearch">pg_textsearch</a> - BM25 全文搜索</li>
<li><a href="https://github.com/timescale/pgvectorscale">pgvectorscale</a> - 高性能向量搜索</li>
<li><a href="https://github.com/timescale/pgai">pgai</a> - AI 嵌入自动化</li>
<li><a href="https://github.com/tembo-io/pgmq">pgmq</a> - 消息队列</li>
<li><a href="https://github.com/citusdata/pg_cron">pg_cron</a> - 定时任务</li>
</ul>
<h3 id="学习资源">学习资源</h3>
<ul>
<li><a href="https://use-the-index-luke.com/">Use The Index, Luke</a> - SQL 索引优化</li>
<li><a href="https://www.postgresql.org/docs/current/performance-tips.html">PostgreSQL 高性能实战</a></li>
<li><a href="https://github.com/dhamaniasad/awesome-postgres">awesome-postgres</a> - Postgres 资源列表</li>
</ul>
<hr>
<p><em>本文基于 PostgreSQL 16+ 和现代扩展生态编写，适用于希望简化技术栈的开发和运维团队。</em></p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/kaka-milan-22" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://x.com/kaka99859362" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="mailto:kaka@kakacn.com" target="_blank" rel="noopener noreferrer me"
    title="Email">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
    <polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2026 Kaka.
        
    </small>
</footer>







    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
